<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Webhook Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Teste de Logs de Webhook</h1>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <button class="btn btn-primary" onclick="carregarLogs()">Carregar Logs</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Timestamp</th>
                        <th>TÃ³pico</th>
                        <th>Resource</th>
                        <th>Status</th>
                        <th>Tentativas</th>
                        <th>Erro</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Clique em "Carregar Logs" para ver os dados</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function carregarLogs() {
            console.log('Carregando logs...');
            
            fetch('/api/webhook/logs')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    renderizarLogs(data);
                })
                .catch(error => {
                    console.error('Erro ao carregar logs:', error);
                    document.getElementById('logsTableBody').innerHTML = 
                        '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar logs: ' + error.message + '</td></tr>';
                });
        }
        
        function renderizarLogs(logs) {
            console.log('Renderizando logs:', logs);
            const tbody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum log encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.id}</td>
                    <td>${formatarData(log.processed_at)}</td>
                    <td>${log.topic}</td>
                    <td>${log.resource || 'N/A'}</td>
                    <td>
                        <span class="badge ${log.success ? 'bg-success' : 'bg-danger'}">
                            ${log.success ? 'Sucesso' : 'Erro'}
                        </span>
                    </td>
                    <td>${log.attempts}</td>
                    <td>${log.error_message || '-'}</td>
                </tr>
            `).join('');
        }
        
        function formatarData(dataString) {
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR');
        }
    </script>
</body>
</html>
