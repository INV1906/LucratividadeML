{% extends "base.html" %}

{% block title %}Dashboard - Lucratividade Mercado Livre{% endblock %}
{% block page_title %}{% endblock %}

{% block content %}
<!-- Título Principal -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1 text-primary">
            <i class="fas fa-tachometer-alt me-3"></i>Dashboard
        </h1>
        <p class="text-muted mb-0">Visão geral do seu negócio no Mercado Livre</p>
    </div>
    <div class="text-end">
        <span class="badge bg-success fs-6 px-3 py-2">
            <i class="fas fa-chart-line me-2"></i>Visão Geral
        </span>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-12 col-sm-6 col-md-3 mb-3">
        <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body text-center">
                <div class="stat-number fs-1 fw-bold text-primary">{{ analise.total_vendas or 0 }}</div>
                <div class="stat-label fs-6 text-muted">
                    <i class="fas fa-shopping-cart me-1 text-primary"></i>Vendas (30 dias)
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
        <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body text-center">
                <div class="stat-number fs-1 fw-bold text-success">{{ "R$ {:.2f}".format(analise.receita_total or 0) }}</div>
                <div class="stat-label fs-6 text-muted">
                    <i class="fas fa-dollar-sign me-1 text-success"></i>Receita Total
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
        <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body text-center">
                <div class="stat-number fs-1 fw-bold text-info">{{ "R$ {:.2f}".format(analise.ticket_medio or 0) }}</div>
                <div class="stat-label fs-6 text-muted">
                    <i class="fas fa-receipt me-1 text-info"></i>Ticket Médio
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3">
        <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body text-center">
                <div class="stat-number fs-1 fw-bold text-warning">{{ analise.total_produtos_ativos or 0 }}</div>
                <div class="stat-label fs-6 text-muted">
                    <i class="fas fa-box me-1 text-warning"></i>Produtos Ativos
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Vendas -->
    <div class="col-12 col-lg-6 mb-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-dark border-0 py-3">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-chart-line me-2 text-white"></i>
                    Vendas dos Últimos 30 Dias
                </h5>
            </div>
            <div class="card-body p-0 d-flex flex-column">
                <div class="chart-container flex-grow-1">
                    <canvas id="vendasChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Produtos -->
    <div class="col-12 col-lg-6 mb-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-dark border-0 py-3">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-star me-2 text-white"></i>
                    Top Produtos
                </h5>
            </div>
            <div class="card-body p-4">
                {% if analise.top_produtos %}
                    {% for produto in analise.top_produtos %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 rounded" 
                         style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 text-dark fw-semibold">{{ produto.title }}</h6>
                            <small class="text-success fw-bold">
                                <i class="fas fa-shopping-cart me-1"></i>{{ produto.sold_quantity }} vendas
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success fs-6 px-3 py-2">
                                {{ "R$ {:.2f}".format(produto.price or 0) }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-box-open text-muted fs-1 mb-3"></i>
                        <p class="text-muted">Nenhum produto encontrado</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Vendas Recentes -->
    <div class="col-12 col-lg-6 mb-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-dark border-0 py-3">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-shopping-cart me-2 text-white"></i>
                    Vendas Recentes
                </h5>
            </div>
            <div class="card-body p-0">
                {% if vendas %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0 py-3 px-4 fw-semibold text-white">Pack ID</th>
                                <th class="border-0 py-3 px-4 fw-semibold text-white">Produtos</th>
                                <th class="border-0 py-3 px-4 fw-semibold text-white">Valor Total</th>
                                <th class="border-0 py-3 px-4 fw-semibold text-white">Data</th>
                                <th class="border-0 py-3 px-4 fw-semibold text-white">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venda in vendas %}
                            <tr class="border-0">
                                <td class="py-3 px-4">
                                    <code class="bg-light px-2 py-1 rounded">{{ venda.pack_id }}</code>
                                </td>
                                <td class="py-3 px-4">
                                    <div>
                                        <span class="badge bg-primary me-2">{{ venda.total_produtos }} produtos</span><br>
                                        <small class="text-muted mt-1 d-block" style="max-width: 200px;" title="{{ venda.produtos or 'N/A' }}">
                                            {{ venda.produtos or 'N/A' }}
                                        </small>
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="badge bg-success fs-6 px-3 py-2">
                                        {{ "R$ {:.2f}".format(venda.valor_total or 0) }}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <small class="text-muted">{{ venda.data_aprovacao.strftime('%d/%m/%Y') if venda.data_aprovacao else '-' }}</small>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="badge bg-success">{{ venda.status or 'Aprovado' }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart text-muted fs-1 mb-3"></i>
                    <p class="text-muted">Nenhuma venda encontrada</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sugestões -->
    <div class="col-12 col-lg-6 mb-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-dark border-0 py-3">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-lightbulb me-2 text-white"></i>
                    Sugestões
                </h5>
            </div>
            <div class="card-body p-4">
                {% if sugestoes %}
                    {% for sugestao in sugestoes %}
                    <div class="alert alert-{{ 'danger' if sugestao.prioridade >= 8 else 'warning' if sugestao.prioridade >= 6 else 'info' }} border-0 shadow-sm mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold mb-0">{{ sugestao.titulo }}</h6>
                            <span class="badge bg-{{ 'danger' if sugestao.prioridade >= 8 else 'warning' if sugestao.prioridade >= 6 else 'info' }} fs-6">
                                Prioridade {{ sugestao.prioridade }}
                            </span>
                        </div>
                        <p class="mb-2">{{ sugestao.descricao }}</p>
                        
                        {% if sugestao.produtos %}
                        <div class="mt-3">
                            <small class="text-muted fw-semibold">Produtos relacionados:</small>
                            <div class="mt-2">
                                {% for produto in sugestao.produtos[:3] %}
                                <div class="d-flex justify-content-between align-items-center py-1 px-2 rounded mb-1" 
                                     style="background: rgba(255,255,255,0.3);">
                                    <div class="flex-grow-1" style="min-width: 0;">
                                        <small class="fw-semibold" style="word-wrap: break-word; white-space: normal;">{{ produto.title }}</small>
                                        {% if produto.margem is defined %}
                                        <br><small class="text-muted">Margem: {{ produto.margem }}%</small>
                                        {% elif produto.diferenca is defined %}
                                        <br><small class="text-muted">Diferença: {{ produto.diferenca }}%</small>
                                        {% elif produto.estoque is defined %}
                                        <br><small class="text-muted">Estoque: {{ produto.estoque }} | Vendas: {{ produto.vendas }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        {% if produto.price is defined %}
                                        <small class="fw-bold">R$ {{ "%.2f"|format(produto.price) }}</small>
                                        {% elif produto.preco_atual is defined %}
                                        <small class="fw-bold">R$ {{ "%.2f"|format(produto.preco_atual) }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                                {% if sugestao.produtos|length > 3 %}
                                <small class="text-muted">... e mais {{ sugestao.produtos|length - 3 }} produtos</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if sugestao.quantidade %}
                        <div class="mt-2">
                            <span class="badge bg-secondary fs-6">{{ sugestao.quantidade }} produtos</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-lightbulb text-muted fs-1 mb-3"></i>
                        <p class="text-muted">Nenhuma sugestão no momento</p>
                        <small class="text-muted">Importe mais dados para receber sugestões personalizadas</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Estilos personalizados para o Dashboard */
.stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 16px !important;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    font-weight: 500;
}

.card {
    border-radius: 16px !important;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.08) !important;
}

.btn {
    transition: all 0.3s ease;
    font-weight: 600;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.badge {
    font-weight: 600;
    border-radius: 8px !important;
}

.alert {
    border-radius: 12px !important;
    border: none !important;
}

/* Animações suaves */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.5s ease-out;
}

/* Altura mínima para cards */
.h-100 {
    min-height: 500px;
}

/* Ajustar altura do gráfico */
#vendasChart {
    width: 100% !important;
    height: 100% !important;
}

/* Container do gráfico responsivo */
.chart-container {
    position: relative;
    height: calc(100vh - 200px);
    min-height: 500px;
    width: 100%;
    flex: 1;
}

@media (max-width: 768px) {
    .chart-container {
        height: calc(100vh - 150px);
        min-height: 400px;
    }
    
    #vendasChart {
        width: 100% !important;
        height: 100% !important;
    }
}

/* Melhorar espaçamento dos cards */
.card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 0 !important;
}

/* Card do gráfico deve ocupar todo o espaço */
.card.h-100 {
    display: flex;
    flex-direction: column;
}

/* Garantir que o gráfico ocupe todo o espaço disponível */
.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
}

/* Ajustar tabela de vendas */
.table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

/* Melhorar layout das sugestões */
.alert {
    margin-bottom: 1rem;
}

.alert:last-child {
    margin-bottom: 0;
}

/* Títulos de produtos nas sugestões */
.alert .fw-semibold {
    word-wrap: break-word;
    white-space: normal;
    line-height: 1.3;
    max-width: 100%;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* Títulos de produtos no Top Produtos */
.card .fw-semibold {
    word-wrap: break-word;
    white-space: normal;
    line-height: 1.3;
    max-width: 100%;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* Container flexível para produtos relacionados */
.alert .d-flex {
    align-items: flex-start;
}

.alert .flex-grow-1 {
    min-width: 0;
    flex: 1;
}

.alert .text-end {
    flex-shrink: 0;
    margin-left: 10px;
}

/* Responsividade aprimorada */
@media (max-width: 768px) {
    .stat-number {
        font-size: 2rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    
    .h-100 {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Gráfico de vendas
const ctx = document.getElementById('vendasChart').getContext('2d');

// Dados reais do backend
const vendasPorDia = {{ analise.vendas_por_dia | tojson | safe }};

// Preparar dados para o gráfico
const labels = vendasPorDia.map(item => {
    const data = new Date(item.data);
    return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
});

const dadosVendas = vendasPorDia.map(item => item.vendas);

const vendasChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Vendas',
            data: dadosVendas,
            borderColor: 'rgb(102, 126, 234)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgb(102, 126, 234)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: 'rgb(102, 126, 234)',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                    label: function(context) {
                        const index = context.dataIndex;
                        const receita = vendasPorDia[index].receita;
                        return `Vendas: ${context.parsed.y} | Receita: R$ ${receita.toFixed(2)}`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)',
                    drawBorder: false
                },
                ticks: {
                    stepSize: 1,
                    color: '#666',
                    font: {
                        size: 12,
                        weight: '500'
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxTicksLimit: 10,
                    color: '#666',
                    font: {
                        size: 12,
                        weight: '500'
                    }
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});
</script>
{% endblock %}
